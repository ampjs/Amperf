'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();var _AmperfTemplate=require('./AmperfTemplate.js'),_AmperfTemplate2=_interopRequireDefault(_AmperfTemplate),_AmperfBenchmark=require('./AmperfBenchmark.js'),_AmperfBenchmark2=_interopRequireDefault(_AmperfBenchmark);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}var a=function(){function a(b){var c=1>=arguments.length||void 0===arguments[1]?{}:arguments[1];return _classCallCheck(this,a),this.definition=b,this.options=c,this.test_item={description:'',log:[]},this.pass_count=0,this.results={},this.current={},this._console=console,this.consoleOutput=[],this.Template=new _AmperfTemplate2.default(this.options.template),this.Template.group(this.definition),this}return _createClass(a,[{key:'test',value:function test(b,c){return this.setDescription=b,this.Template.testItemStart(this.test_item),this._runTests(c),this.Template.testItemResults(this.options.show,this.results),this}},{key:'_runTests',value:function _runTests(b){var c=0,d=0;this.results={time_start:new Date,time_end:null,time_total:null,time_average:0,count:0,iterations:[],time_slowest:null,slowest_iteration:0,time_fastest:null,fastest_iteration:0};do this._consoleReplace(),this.Template.testItemIteration(this.results.count++),this.current=this._runTestIteration(b),this._consoleReinstate(),c+=this.current.execution_time,d+=this.current.memory_used,this._addFastestTime('fastest'),this._addSlowestTime(),this.results.iterations.push(this.current);while(this.results.count<this.options.iterations);return this._calculateEndTimes(c,d),b}},{key:'_runTestIteration',value:function _runTestIteration(b){var c={output:{type:'Test',console:[],returned:null}},d=process.hrtime(),e=process.memoryUsage().rss;try{c.output.returned=b(),c.output.console=this.consoleOutput}catch(f){c.output={type:'Exception',returned:f}}return c.memory_used=this.memoryUsed(e),c.execution_time=this.executionTime(d),c}},{key:'_consoleReplace',value:function _consoleReplace(){for(var b in console)'log'!=b&&(console[b]=this._consoleCatch.bind(this))}},{key:'_consoleCatch',value:function _consoleCatch(){this.consoleOutput.push(arguments)}},{key:'_consoleReinstate',value:function _consoleReinstate(){for(var b in this._console)console[b]=this._console[b]}},{key:'_setTime',value:function _setTime(){var b=0>=arguments.length||void 0===arguments[0]?'fastest':arguments[0];this.results['time_'+b]||(this.results['time_'+b]=this.current.execution_time,this.results[b+'_iteration']=this.results.count)}},{key:'_addFastestTime',value:function _addFastestTime(){this._setTime('fastest'),this.results.time_fastest>this.current.execution_time&&(this.results.time_fastest=this.current.execution_time,this.results.fastest_iteration=this.results.count)}},{key:'_addSlowestTime',value:function _addSlowestTime(){this._setTime('slowest'),this.results.time_slowest<this.current.execution_time&&(this.results.time_slowest=this.current.execution_time,this.results.slowest_iteration=this.results.count)}},{key:'_calculateEndTimes',value:function _calculateEndTimes(b,c){this.results.time_end=new Date,this.results.time_total=this.totalTime(),this.results.time_average=this.timeAverage(b),this.results.memory_average=this.memoryAverage(c)}},{key:'memoryUsed',value:function memoryUsed(b){return process.memoryUsage().rss-b}},{key:'executionTime',value:function executionTime(b){var c=process.hrtime(b);return c[1]/1000000}},{key:'totalTime',value:function totalTime(){return(this.results.time_end-this.results.time_start)/1000}},{key:'timeAverage',value:function timeAverage(b){return b/this.results.count}},{key:'memoryAverage',value:function memoryAverage(b){return(b/this.results.count/1048576).toFixed(2)}},{key:'bench',value:function bench(){var b=0>=arguments.length||void 0===arguments[0]?{}:arguments[0],c=new _AmperfBenchmark2.default(this.results,b);return c.perform()}},{key:'log',value:function log(b){this.test_item.log.push(b)}},{key:'setDescription',set:function set(b){this.test_item.description=b}}]),a}();exports.default=a;